<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库存管理系统 - 管理员界面</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <img src="/images/logo.webp" alt="高力乐 Logo" style="height: 50px;">
            <div>
                <span class="me-3">管理员: admin</span>
                <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">修改密码</button>
                <button onclick="exportToImage()" class="btn btn-success me-2">导出数据</button>
                <button onclick="logout()" class="btn btn-danger">退出登录</button>
            </div>
        </div>

        <div class="row">
            <!-- 库存列表 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">库存列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>商品编号</th>
                                        <th>商品名称</th>
                                        <th>当前库存</th>
                                        <th>库存预警</th>
                                        <th>入库总额</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

          <!-- 添加商品表单部分 -->
<div class="add-item">
    <h3>添加商品</h3>
    <div class="form-group">
        <label for="itemId">商品编号</label>
        <input type="text" id="itemId" required>
    </div>
    <div class="form-group">
        <label for="itemName">商品名称</label>
        <input type="text" id="itemName" required>
    </div>
    <div class="form-group">
        <label for="itemPrice">价格</label>
        <input type="number" id="itemPrice" step="0.01" required>
    </div>
    <div class="form-group">
        <label for="itemStock">初始库存</label>
        <input type="number" id="itemStock" required>
    </div>
    <div class="form-group">
        <label for="warningValue">库存预警值</label>
        <input type="number" id="warningValue" required>
    </div>
    <button onclick="addItem()">添加</button>
</div>

        <!-- 操作记录 -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">操作记录</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>商品</th>
                                <th>操作类型</th>
                                <th>数量</th>
                                <th>操作人</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody id="operationList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 在操作记录表格后添加 -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">用户管理</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">添加用户</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>角色</th>
                                <th>创建时间</th>
                            </tr>
                        </thead>
                        <tbody id="usersList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 添加用户模态框 -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">添加用户</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <div class="mb-3">
                                <label class="form-label">用户名</label>
                                <input type="text" class="form-control" id="newUsername" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">密码</label>
                                <input type="password" class="form-control" id="newPassword" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="addUser()">添加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 修改密码模态框 -->
        <div class="modal fade" id="changePasswordModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">修改密码</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="changePasswordForm">
                            <div class="mb-3">
                                <label class="form-label">原密码</label>
                                <input type="password" class="form-control" id="changeOldPassword" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">新密码</label>
                                <input type="password" class="form-control" id="changeNewPassword" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">确认新密码</label>
                                <input type="password" class="form-control" id="changeConfirmPassword" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="changePassword()">确认修改</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 在页面加载时检查角色
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');
            
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            if (role !== 'admin') {
                alert('无权访问管理员页面');
                window.location.href = '/index.html';
            }
        });

        // 加载库存列表
        async function loadInventory() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/inventory/list', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取库存列表失败');
                }

                const data = await response.json();
                const tbody = document.getElementById('inventoryList');
                tbody.innerHTML = '';
                
                data.inventory.forEach(item => {
                    const tr = document.createElement('tr');
                    const isLow = item.current_stock <= item.warning_value;
                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td class="${isLow ? 'text-danger fw-bold' : ''}">${item.current_stock}</td>
                        <td>${item.warning_value}</td>
                        <td>¥ ${item.total_value.toFixed(2)}</td>
                        <td>
                            <button onclick="deleteItem('${item.id}')" class="btn btn-danger btn-sm">删除</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('加载库存失败:', error);
            }
        }

        // 加载操作历史
        async function loadOperationHistory() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/inventory/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取操作历史失败');
                }

                const data = await response.json();
                const tbody = document.getElementById('operationList');
                tbody.innerHTML = '';
                
                data.history.forEach(operation => {
                    const tr = document.createElement('tr');
                    const date = new Date(operation.timestamp);
                    const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                    
                    tr.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>${operation.item_name}</td>
                        <td>${operation.operation_type === 'in' ? '入库' : '出库'}</td>
                        <td>${operation.quantity}</td>
                        <td>${operation.operator}</td>
                        <td>${operation.remark || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('加载操作历史失败:', error);
            }
        }

        // 添加商品
        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('itemId').value;
            const itemName = document.getElementById('itemName').value;
            const warningValue = document.getElementById('warningValue').value;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/inventory/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        id: itemId,
                        name: itemName,
                        warning_value: warningValue
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('添加成功');
                    this.reset();
                    loadInventory();
                } else {
                    alert(data.message || '添加失败');
                }
            } catch (error) {
                console.error('添加失败:', error);
                alert('添加失败，请重试');
            }
        });

        // 删除商品
        async function deleteItem(itemId) {
            if (!confirm('确定要删除这个商品吗？')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/inventory/delete/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('删除成功');
                    loadInventory();
                } else {
                    alert(data.message || '删除失败');
                }
            } catch (error) {
                console.error('删除失败:', error);
                alert('删除失败，请重试');
            }
        }

        // 退出登录
        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // 导出数据为图片
        async function exportToImage() {
            try {
                const exportDiv = document.createElement('div');
                exportDiv.style.padding = '20px';
                exportDiv.style.backgroundColor = 'white';
                
                const now = new Date();
                const timestamp = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                // 添加标题和时间
                exportDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <img src="/images/logo.webp" alt="Logo" style="height: 40px;">
                        <h2 style="margin-left: 20px; margin-bottom: 0;">库存数据报表</h2>
                    </div>
                    <p style="margin-bottom: 20px;">导出时间：${timestamp}</p>
                `;
                
                // 添加库存信息
                const inventorySection = document.createElement('div');
                inventorySection.innerHTML = '<h4 style="margin-bottom: 15px;">库存列表</h4>';
                const inventoryTable = document.querySelector('.table').cloneNode(true);
                // 移除最后一列（操作按钮）
                inventoryTable.querySelectorAll('tr').forEach(row => {
                    const lastCell = row.lastElementChild;
                    if (lastCell) row.removeChild(lastCell);
                });
                inventorySection.appendChild(inventoryTable);
                exportDiv.appendChild(inventorySection);

                // 添加操作记录
                const historySection = document.createElement('div');
                historySection.style.marginTop = '30px';
                historySection.innerHTML = '<h4 style="margin-bottom: 15px;">操作记录</h4>';
                const historyTable = document.querySelectorAll('.table')[1].cloneNode(true);
                historySection.appendChild(historyTable);
                exportDiv.appendChild(historySection);
                
                document.body.appendChild(exportDiv);
                
                const canvas = await html2canvas(exportDiv, {
                    scale: 2,
                    backgroundColor: 'white',
                    logging: false,
                    width: exportDiv.offsetWidth,
                    height: exportDiv.offsetHeight
                });
                
                document.body.removeChild(exportDiv);
                
                const image = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = `库存报表_${timestamp.replace(/[: ]/g, '_')}.png`;
                link.href = image;
                link.click();
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请重试');
            }
        }

        // 加载用户列表
        async function loadUsers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/auth/users/list', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    const tbody = document.getElementById('usersList');
                    tbody.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.role === 'admin' ? '管理员' : '普通用户'}</td>
                            <td>${new Date(user.created_at).toLocaleString()}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
            }
        }

        // 添加用户
        async function addUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/auth/users/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success) {
                    alert('用户添加成功');
                    document.getElementById('addUserForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    loadUsers();
                } else {
                    alert(data.message || '添加失败');
                }
            } catch (error) {
                console.error('添加用户失败:', error);
                alert('添加用户失败，请重试');
            }
        }

        // 修改密码
        async function changePassword() {
            const oldPassword = document.getElementById('changeOldPassword').value;
            const newPassword = document.getElementById('changeNewPassword').value;
            const confirmPassword = document.getElementById('changeConfirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一致');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                const data = await response.json();
                if (data.success) {
                    alert('密码修改成功，请重新登录');
                    document.getElementById('changePasswordForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    logout();
                } else {
                    alert(data.message || '修改失败');
                }
            } catch (error) {
                console.error('修改密码失败:', error);
                alert('修改密码失败，请重试');
            }
        }

        // 确保初始加载和定时刷新都正确执行
        document.addEventListener('DOMContentLoaded', () => {
            loadInventory();
            loadOperationHistory();
            loadUsers();
            setInterval(() => {
                loadInventory();
                loadOperationHistory();
                loadUsers();
            }, 30000);
        });
    </script>
</body>
</html> 
